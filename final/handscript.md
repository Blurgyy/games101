# handscript

title: 我选择的题目是 2.4.2 用两个三角形渲染世界.

我用这种方法渲染了一个冰淇淋, 就像右边这个 emoji.

这是我渲染的最终效果截图. 演示视频可以在这里看到.

使用两个三角形渲染的基本思想是:

1. 先构造两个能够覆盖整个屏幕的三角形
2. 然后在片段着色器中直接构建距离场, 有了距离场就可以计算法向量场
3. 最后使用 ray marching 方法逐像素渲染

就可以得到距离场描述的场景.

***

我的实现过程是: 把冰淇淋分成了甜筒, 奶油和糖果三部分, 分别构造距离场并组合, 然后对各部分添加不同的材质属性, 最后利用 ray marching 的特性估计了软阴影和环境光照.

***

右边的是 emoji 版本的冰淇淋, 它的甜筒部分可以进一步分解为这样的几个部分.

中心在原点的圆台以 Y 轴为中心对称.
于是可以把距离的计算变换到二维中, 求点 q 到梯形的距离.
根据点 q 的位置, 可以对五个区域分别计算.

我把碗形实现为球体被两个平面截断的结果. 碗形同样关于 y 轴对称, 可以类似的求出距离场.

环和线段的距离场也可以简单推导得到.

五个部分分别实现后, 组合起来就得到了甜筒.

***

奶油部分可以看作两层辐射状排列的锥形拧起来的结果. 锥形之间应当平滑融合, 体现奶油的物理性质.

锥形可以看做顶部半径为 0 的圆台, 直接使用圆台的距离场即可得到锥形的距离场函数.

锥形需要有平滑的边缘来体现奶油的形态.

我使用了对视点的变换来实现绕轴对称的锥形, 以及"拧起来"的效果.

两层奶油实现为这个样子, 组合后就得到了冰淇淋的头部.

***

糖果使用小立方体体现, 也应该有平滑的边缘.

糖果应当有随机的方向. 对物体的旋转可以通过对视点做旋转的逆变换实现.

这是空中的糖果随时间旋转的部分伪代码.

实现糖果后, 和前面的两部分组合即可得到冰淇淋形状.

***

着色阶段, 我首先估计了软阴影.

对软阴影的估计基于这样的观察:

这两个距离在 ray marching 过程中都可以方便地得到. 确定正反比关系后添加一个系数就可以估计软阴影.

效果是这样.

***

我对冰淇淋三部分分配了不同的材质.

用这样的方式控制材质的颜色和粗糙程度.

空间中某一点的材质被认为是最靠近该点的物体的材质. 所以在 ray marching 过程中动态更新材质属性即可.

这是添加材质后的效果.

组合后是这样.

***

最后我利用 ray marching 的特性估计了环境光照和环境光遮蔽, 并且添加了反走样.

最终效果就是这样.

***

这些是我在编写过程中参考的资料. 感谢观看!
