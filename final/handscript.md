# handscript

title: 我选择的题目是 2.4.2 用两个三角形渲染世界.

我用这种方法渲染了一个冰淇淋, 就像右边这个 emoji.

这是我渲染的最终效果截图. 演示视频可以在这里看到.

使用两个三角形渲染的基本思想是:

1. 先构造两个能够覆盖整个屏幕的三角形, 可以直接用图中这样的两个直角三角形;
2. 然后在片段着色器中直接构建距离场, 距离场在物体内部为负值, 空间中点 p 处距离场的梯度方向就是该点处的法向量方向, 距离场的梯度方向可以用数值方法计算得到, 所以有了距离场也就有了法向量场.
3. 最后使用 ray marching 方法逐像素渲染.

就可以得到距离场描述的场景.

***

我的实现过程是: 把冰淇淋分成了甜筒, 奶油和糖果三部分, 分别构造距离场并组合为一个距离场, 然后对冰淇淋各部分添加不同的材质属性, 最后利用 ray marching 的特性估计了软阴影和环境光照.

***

右边的是 emoji 版本的冰淇淋, 它的甜筒部分可以进一步分解成五部分: 一个底部的圆台, 一个中间的圆台, 一个顶部的碗形, 以及底部圆台上附加的三个环和若干条竖线.

中心在三维空间原点的圆台以 Y 轴为中心对称.
空间中点 p 到圆台的距离可以转化为这样的二维点 q 到一个这样的梯形边界的距离. 梯形又关于 Y 轴对称, 计算就转化到了右半平面内.
根据点 q 的位置, 梯形自然被分为五个部分. 当 q 在梯形内部时距离场应当返回负值, 否则无法正确对圆台的侧面计算法向量方向.

碗形可以看作一个完整的球被两个平面截断的结果. 碗形同样以 Y 轴为中心对称, 把球心放在原点后, 距离转化为二维点 q 到这样的形状的距离. 可以用类似方法求出距离场.

环和线段的距离场可以简单推导得到. 分别实现后, 求所有距离场的最小值就可以把五个部分组合起来.

甜筒组合后是这个样子.

***

再看这个 emoji 版本的冰淇淋, 上面的奶油可以分成两层, 每层是以顶同一个点为顶点的若干个锥形拧起来的结果.
最后每层内的锥形和两层之间使用平滑融合, 来模拟奶油的物理性质.

锥形的距离场可以使用前面类似的方法得到, 也可以直接把锥形看作顶部半径为 0 的圆台, 就能直接用前面的函数求出中心在原点的锥形的距离场.
再次考虑到奶油的物理性质, 锥形不应该有尖锐的边缘. 可以把距离场减去边缘的半径来得到平滑的边缘.

得到一个锥形后, 可以通过变换空间点 p 来得到绕轴旋转的若干个物体. 在循环里求出使用不同变换得到的距离场, 最后求最小值就能得到多个绕轴旋转的物体.
要实现"拧起来"的结果, 就要根据物体的 y 轴坐标实现不同程度的旋转. 可以用类似的方式实现.

这里是实现过程, 上下两层方式相同, 区别在于锥形的形状, 个数和扭转程度.

奶油组合后是这个样子.

***

最后是糖果, 糖果就是小立方体, 也不能有锋利的边缘.

并且每个糖果应该有随机的方向, 我也为空中的三颗糖果添加了上下浮动和缓慢旋转的动态.

对物体的旋转可以通过对 ray marching 起点做旋转的逆变换实现. 这里是绕 x 轴旋转的实现, 前面的奶油也用到了旋转操作.

糖果最终是这个样子. 把糖果和前面两部分组合起来就得到了基本的冰淇淋形状.

***

在上色过程中, 我首先添加了软阴影.

对软阴影的估计基于这样的观察:
在光线照亮点 p 的路径上,

1. xxx
2. xxx

这两个信息在 ray marching 中都可以方便地得到. 添加一个系数 k 就可以实现估计软阴影.

效果是这样.

***

冰淇淋的三部分显然有不同的材质, 我添加了这样的材质属性, 分别控制了材质的颜色和粗糙程度.
空间中某一点的材质被认为是最靠近该点的物体的材质. 于是在 ray marching 过程中动态更新材质属性即可.

这是为冰淇淋三个部分分别添加材质后的效果.

组合后是这样.

***

最后我利用 ray marching 的特性估计了环境光遮蔽, 然后添加了反走样.
最终效果就是这样了.

***

这些是我在编写过程中参考的资料. 感谢观看!
